[中文](./README_zh.md) [English](./README.md)

## Signal VM

通过异常进入各种handler，从而实现虚拟机。

参考了强网杯2018的题目 obf ，基于这道题的基础上魔改了一下。

我找不到官方wp了 ，所以只好把原题贴一下，感兴趣的可以看看。

### 流程

先fork出一个子进程，父进程会调试子进程，子进程会进入各种由异常组成的bytecode，父进程根据异常的类型进行各种虚拟机操作。

Signal VM 和Signal VM Δ 不同的一点在于，第一题直接对父进程本身的数据进行操作，子进程只是起到传达code的作用

第二题使用PTRACE_PEEKTEXT 和PTRACE_POKETEXT，直接修改子进程的内存。

这样在我们调试父进程的时候，在第一题中可以直接监视VM寄存器和VM的内存，从而帮助我们理解指令。

而在第二题中，由于子进程已经被父进程调试了，我们无法附加上去，无法查看子进程的内存，只能查看父进程调试获取的数据，加大了理解指令的难度，分析解析指令这一部分更为重要。

### 指令

指令大致分为三部分：opcode， 操作数类型，操作数

除了int 3断点，还添加了三种不同的异常

```
signal    | machine code | handler
-------------------------------------------
SIGILL    | 06           | mov, lea ...
SIGTRAP   | CC           | add, sub, mul div ...
SIGSEGV   | 00 00        | jcc
SIGFPE    | 30 C0 F6 F8  | cmp
```

opcode之后有一个字节用来标识操作数的类型（除了jcc）

高 4 bit代表第一个操作数，低 4 bit代表第二个操作数，其中：

```
0  register
1  immediate
2  address
```

地址只能是由寄存器指向，第一个操作数不能为立即数，立即数位32位

在这之后是两个操作数，应当根据操作数类型进行匹配。寄存器占一个字节，立即数占四个字节。

### 算法

两道题的算法都不算难。

第一题为hill cipher

第二题可以参考https://projecteuler.net/problem=67，我们需要求出最大和的路径，路径中包含flag。

可以动态规划从下往上叠加，取相邻两个中的较大的一个，具体参考解题脚本。

构造数据的时候保证每行与最大值相邻的不会相等，这样排除了多解的情况。

### 源代码

vm1.c和vm2.c是两道题的源代码，由于我比较菜，写的也比较仓促，代码质量可能不高。。。

hill.c和triangle.c是算法的源码

assembly1.txt和assembly2.txt是vm的汇编代码，我直接从x86汇编翻译过来的。。。

simulate1.py和simulate2.py是解析bytecode并模拟执行，然后把bytecode写进bytecode1 和bytecode2。

solve1.py和solve2.py是参考脚本。

### 总结

虚拟机结构还有很多不足的地方。可以触发的异常比较少，因此指令不能设置太多。没有区分有符号与无符号数，总的来说还是太菜了。

第二题其实是第一天晚上临时起意改出来的，一开始没准备出两道题。最早不知道可以有修改子进程的方法，后来查了一些资料才了解到的，然后爆肝一晚改出了第二道题。原本第二题只有这一个算法的。。。如果直接放第二题可能效果会更好一点。。。

有任何问题可以tg联系我 [@Apeng7364](https://t.me/Apeng7364)